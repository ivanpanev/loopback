- name: PANORAMA Config Tasks
  block:
    - name: PANORAMA Create tag object 'GTT MDR'
      paloaltonetworks.panos.panos_tag_object:
        provider:
          ip_address: '{{ device.panorama_mgmt_address }}'
          username: '{{ device.username }}'
          password: '{{ device.password }}'
        device_group: '{{ device.panorama_device_group }}'
        name: 'GTT MDR'
        color: 'chestnut'
        comments: 'GTT Managed Detection and Response'
      delegate_to: localhost

    - name: PANORAMA Gather all address objects
      paloaltonetworks.panos.panos_address_object:
        provider:
          ip_address: '{{ device.panorama_mgmt_address }}'
          username: '{{ device.username }}'
          password: '{{ device.password }}'
        device_group: '{{ device.panorama_device_group }}'
        state: gathered
        gathered_filter: '*'
      register: gathered_address_objects
      delegate_to: localhost

    - name: PANORAMA Create address objects for unconfigured IPs
      paloaltonetworks.panos.panos_address_object:
        provider:
          ip_address: '{{ device.panorama_mgmt_address }}'
          username: '{{ device.username }}'
          password: '{{ device.password }}'
        device_group: '{{ device.panorama_device_group }}'
        name: "MDR-BLOCKED-{{ ip | regex_replace('/', 'm') }}"
        value: "{{ ip }}"
        description: "Suspicious host identified by GTT Managed Detection and Response"
        tag: ['GTT MDR']
        commit: false
      loop: "{{ device.block_ips }}"
      loop_control:
        loop_var: ip
      when: device.block_ips | length > 0
      register: result_of_object_creation
      delegate_to: localhost

    - name: PANORAMA Gather a list of new objects' names 
      set_fact:
        relevant_address_objects: "{{ (gathered_address_objects.gathered | selectattr('value', 'in', device.block_ips) | map(attribute='name') | list) +
                                      (result_of_object_creation.results | selectattr('changed', 'equalto', true) | map(attribute='invocation.module_args.name') | list if result_of_object_creation is defined else []) }}"
      delegate_to: localhost

    - name: PANORAMA Gather existing object group
      paloaltonetworks.panos.panos_address_group:
        provider:
          ip_address: '{{ device.panorama_mgmt_address }}'
          username: '{{ device.username }}'
          password: '{{ device.password }}'
        device_group: '{{ device.panorama_device_group }}'
        state: gathered
        gathered_filter: 'name == "GTT-MDR-Blocked-Addresses"'
      register: gathered_object_group
      delegate_to: localhost

    - name: Initialize main group info
      set_fact:
        main_group_exists: "{{ gathered_object_group.gathered | length > 0 }}"
        main_group_members: "{{ gathered_object_group.gathered[0].static_value | default([]) if main_group_exists else [] }}"
        subgroups: "{{ main_group_members | select('match', '^GTT-MDR-Blocked-Addresses-\\d+$') | list }}"
        address_objects_in_main: "{{ main_group_members | reject('match', '^GTT-MDR-Blocked-Addresses-\\d+$') | list }}"
        current_subgroup: ""

    - name: Migrate address objects to subgroup if needed
      block:
        - name: Create initial subgroup
          paloaltonetworks.panos.panos_address_group:
            provider:
              ip_address: '{{ device.panorama_mgmt_address }}'
              username: '{{ device.username }}'
              password: '{{ device.password }}'
            device_group: '{{ device.panorama_device_group }}'
            name: 'GTT-MDR-Blocked-Addresses-001'
            static_value: "{{ address_objects_in_main }}"
            description: "Initial subgroup for migrated addresses"
            tag: ['GTT MDR']
            commit: false
          register: initial_subgroup
          when: address_objects_in_main | length > 0

        - name: Update main group with initial subgroup
          paloaltonetworks.panos.panos_address_group:
            provider:
              ip_address: '{{ device.panorama_mgmt_address }}'
              username: '{{ device.username }}'
              password: '{{ device.password }}'
            device_group: '{{ device.panorama_device_group }}'
            name: 'GTT-MDR-Blocked-Addresses'
            static_value: "['GTT-MDR-Blocked-Addresses-001']"
            description: "Suspicious hosts identified by GTT Managed Detection and Response"
            tag: ['GTT MDR']
            commit: false
          register: update_main_group
          when: address_objects_in_main | length > 0

        - name: Set current subgroup to initial
          set_fact:
            current_subgroup: 'GTT-MDR-Blocked-Addresses-001'
          when: address_objects_in_main | length > 0
      when:
        - main_group_exists
        - subgroups | length == 0
        - address_objects_in_main | length > 0

    - name: Determine latest subgroup
      block:
        - name: Extract subgroup suffixes
          set_fact:
            subgroup_suffixes: "{{ subgroups | map('regex_replace', '^GTT-MDR-Blocked-Addresses-(\\d+)$', '\\1') | map('int') | list }}"

        - name: Get max suffix
          set_fact:
            max_suffix: "{{ (subgroup_suffixes | max) | default(0) }}"

        - name: Set current subgroup name
          set_fact:
            current_subgroup: "GTT-MDR-Blocked-Addresses-{{ '%03d' % max_suffix }}"
      when:
        - main_group_exists
        - subgroups | length > 0

    - name: Get current subgroup members
      block:
        - name: Gather current subgroup info
          paloaltonetworks.panos.panos_address_group:
            provider:
              ip_address: '{{ device.panorama_mgmt_address }}'
              username: '{{ device.username }}'
              password: '{{ device.password }}'
            device_group: '{{ device.panorama_device_group }}'
            state: gathered
            gathered_filter: 'name == "{{ current_subgroup }}"'
          register: current_subgroup_info
          when: current_subgroup != ""

        - name: Set current subgroup members
          set_fact:
            current_subgroup_members: "{{ current_subgroup_info.gathered[0].static_value | default([]) }}"
          when: current_subgroup_info.gathered | length > 0
      when: current_subgroup != ""

    - name: Create new subgroup if needed
      block:
        - name: Calculate new suffix
          set_fact:
            new_suffix: "{{ max_suffix + 1 }}"

        - name: Set new subgroup name
          set_fact:
            new_subgroup: "GTT-MDR-Blocked-Addresses-{{ '%03d' % new_suffix }}"

        - name: Create new subgroup
          paloaltonetworks.panos.panos_address_group:
            provider:
              ip_address: '{{ device.panorama_mgmt_address }}'
              username: '{{ device.username }}'
              password: '{{ device.password }}'
            device_group: '{{ device.panorama_device_group }}'
            name: '{{ new_subgroup }}'
            static_value: "{{ relevant_address_objects }}"
            description: "Subgroup {{ new_suffix }} for blocked addresses"
            tag: ['GTT MDR']
            commit: false
          register: create_subgroup

        - name: Update main group with new subgroup
          paloaltonetworks.panos.panos_address_group:
            provider:
              ip_address: '{{ device.panorama_mgmt_address }}'
              username: '{{ device.username }}'
              password: '{{ device.password }}'
            device_group: '{{ device.panorama_device_group }}'
            name: 'GTT-MDR-Blocked-Addresses'
            static_value: "{{ main_group_members + [new_subgroup] }}"
            description: "Suspicious hosts identified by GTT Managed Detection and Response"
            tag: ['GTT MDR']
            commit: false
          register: update_main_group

        - name: Update current subgroup
          set_fact:
            current_subgroup: '{{ new_subgroup }}'
      when:
        - current_subgroup != ""
        - (current_subgroup_members | length + relevant_address_objects | length) > 1400

    - name: Add to existing subgroup
      paloaltonetworks.panos.panos_address_group:
        provider:
          ip_address: '{{ device.panorama_mgmt_address }}'
          username: '{{ device.username }}'
          password: '{{ device.password }}'
        device_group: '{{ device.panorama_device_group }}'
        name: '{{ current_subgroup }}'
        static_value: "{{ current_subgroup_members + relevant_address_objects }}"
        description: "Updated subgroup with new blocked addresses"
        tag: ['GTT MDR']
        commit: false
      register: update_subgroup
      when:
        - current_subgroup != ""
        - (current_subgroup_members | length + relevant_address_objects | length) <= 1400

    - name: Create initial group and subgroup if none exist
      block:
        - name: Create initial subgroup
          paloaltonetworks.panos.panos_address_group:
            provider:
              ip_address: '{{ device.panorama_mgmt_address }}'
              username: '{{ device.username }}'
              password: '{{ device.password }}'
            device_group: '{{ device.panorama_device_group }}'
            name: 'GTT-MDR-Blocked-Addresses-001'
            static_value: "{{ relevant_address_objects }}"
            description: "Initial subgroup for blocked addresses"
            tag: ['GTT MDR']
            commit: false
          register: initial_subgroup

        - name: Create main group
          paloaltonetworks.panos.panos_address_group:
            provider:
              ip_address: '{{ device.panorama_mgmt_address }}'
              username: '{{ device.username }}'
              password: '{{ device.password }}'
            device_group: '{{ device.panorama_device_group }}'
            name: 'GTT-MDR-Blocked-Addresses'
            static_value: "['GTT-MDR-Blocked-Addresses-001']"
            description: "Suspicious hosts identified by GTT Managed Detection and Response"
            tag: ['GTT MDR']
            commit: false
          register: create_main_group
      when:
        - not main_group_exists
        - relevant_address_objects | length > 0

    # Existing tasks for security rule, commit, and push remain unchanged

  rescue:
    - name: Error handling placeholder task
      debug:
        msg: 'The implementation of the current ticket has failed'
