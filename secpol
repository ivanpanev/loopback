  - name: Serialise extra_vars for the Python script
    set_fact:
      extra_vars_json: "{{ extra_vars | to_json }}"
    no_log: true                             # keep secrets out of logs

  # Copy the whole scripts folder only if the jumphost is remote
  - name: Copy Python helper folder to {{ nb_jumphost }}
    copy:
      src: "{{ scripts_dir }}/"
      dest: /tmp/palo_scripts/
      mode: "0755"
      recurse: yes
    delegate_to: "{{ nb_jumphost }}"
    when: nb_jumphost != 'localhost'

  # Execute main.py where it now lives
  - name: Run main.py on {{ nb_jumphost }}
    command: >
      python3 {{
        (nb_jumphost == 'localhost')
        | ternary(scripts_dir + '/main.py', '/tmp/palo_scripts/main.py')
      }}
    delegate_to: "{{ nb_jumphost }}"
    environment:
      EXTRA_VARS: "{{ extra_vars_json }}"
    register: python_result

  # Optional: show what the script printed
  - name: Show script stdout
    debug:
      var: python_result.stdout_lines
    when: show_extra_vars | default(true)
