I am again getting the error:

TASK [Bail if no firewall entry was found] *************************************
fatal: [localhost]: FAILED! => {"changed": false, "msg": "No device found with GNID 2498163"}

Here's is another similar playbook which works, but is designed to handle lists of GNIDs:


- name: Query NetBox endpoints
  vars:
    endpoints:
      - { path: "dcim/devices/", role: "478" }
      - { path: "virtualization/virtual-machines/", role: "136" }
      - { path: "virtualization/virtual-machines/", role: "477" }
      - { path: "virtualization/virtual-machines/", role: "226" }
      - { path: "virtualization/virtual-machines/", role: "85" }

  block:
  - name: Search NetBox API
    uri:
      url: "{{ netbox_base }}{{ endpoint.path }}?role_id={{ endpoint.role }}&cf_cmd_gnid={{ current_gnid }}"
      headers:
        Authorization: "Token {{ netbox_token }}"
      validate_certs: no
      return_content: yes
      status_code: 200
    delegate_to: 10.160.2.22
    loop: "{{ endpoints }}"
    loop_control:
      loop_var: endpoint
      label: "{{ endpoint.role }}"
    register: netbox_results
    changed_when: false
    failed_when: false

  - name: Extract firewall records
    vars:
      objects: "{{ item.1 }}"
    set_fact:
      firewall_list: >-
        {{ firewall_list + [{
             'gnid'    : current_gnid,
             'ip'      : (objects.primary_ip4.address | default(objects.primary_ip.address) | split('/')).0,
             'role'    : item.0.endpoint.role,
             'jumphost': ('10.160.2.22'
                           if item.0.endpoint.role in ['478','477','226','85']
                           else 'localhost')
           }] }}
    loop: "{{ query('subelements', netbox_results.results,
                   'json.results', skip_missing=True) }}"
    loop_control:
      label: "{{ (objects.primary_ip4.address | default(objects.primary_ip.address) | split('/')).0 }}"

  - name: Show running list
    debug:
      var: firewall_list

- name: Validate results
  fail:
    msg: "No entries found for GNID {{ current_gnid }}"
  when: current_gnid not in firewall_list | map(attribute='gnid') | list


and here is the main playbook which calls that similar gnid list handling playbook:

---

- name: Lookup device in NetBox and update PrimaryIP
  hosts: localhost
  gather_facts: no
  connection: local
  vars:
    netbox_base: "https://netbox.gt-t.net/api/"

  tasks:
  - name: Get vault passwords
    set_fact:
      vault: "{{ lookup('hashi_vault', 'secret=ansible/data/tss') }}"
    no_log: true

  - name: Set NetBox token as a fact
    set_fact:
      netbox_token: "{{ vault.netbox_soc_token }}"
    no_log: true

  - name: Show incoming hostvars/extra_vars
    debug:
      var: hostvars[inventory_hostname]
    when: show_extra_vars | default(true)

  - name: Determine current GNID once
    set_fact:
      current_gnid: >-
        {{
            (hostvars[inventory_hostname].extra_vars.RequestDetails.GNID
               if (hostvars[inventory_hostname].extra_vars is defined
                   and hostvars[inventory_hostname].extra_vars.RequestDetails is defined)
               else RequestDetails.GNID)
        }}

  - name: Lookup PaloAlto firewall details in NetBox
    include_tasks: include_tasks/netbox_palo_fw_lookup.yml

  - name: Bail if no firewall entry was found
    fail:
      msg: "No device found with GNID {{ current_gnid }}"
    when: nb_primary_ip is not defined

  - name: Ensure extra_vars dict exists
    set_fact:
      extra_vars: {}
    when: extra_vars is not defined

  - name: Inject NetBox data into extra_vars.RequestDetails
    set_fact:
      extra_vars: >-
        {{ extra_vars
           | combine(
               {'RequestDetails':
                 (extra_vars.RequestDetails | default({}))
                 | combine({
                     'PrimaryIP'   : nb_primary_ip,
                     'role_id'     : nb_role_id,
                     'jumphost'    : nb_jumphost,
                     'panorama_ip' : nb_panorama_ip
                   })
               },
               recursive=true
             )
        }}

  - name: Show updated extra_vars
    debug:
      var: hostvars[inventory_hostname].extra_vars
    when:
      - show_extra_vars | default(true)
      - nb_primary_ip is defined


Compare these with my single-gnid-handling playbooks you just created and figgure out why the aerror is appearing.

Refer to it and make sure
