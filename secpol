from concurrent.futures import ThreadPoolExecutor, as_completed
from datetime import datetime
import sys
import time
import json
import itertools
from functools import partial
#from global_logger import logger
import requests
import urllib3
import xml.etree.ElementTree as ET
import re

def get_api_key(palo_ip, username, password):
    """
    Generates an XML API key from a firewall.
    
    Args:
        palo_ip (str): Management IP address of the firewall.
        username (str): Username for the firewall.
        password (str): Password for the firewall.
        
    Returns:
        str: An XML API key.
        
    Raises:
        Exception: If the API key retrieval fails.
    """
    print(f"Username: {username}, password: {password}")
    url = f'https://{palo_ip}/api'
    params = {
        'type': 'keygen',
        'user': username,
        'password': password
    }
    try:
        print(f"Trying to get. URL is '{url}'")
        response = requests.get(url, params=params, verify=False)
        if response.status_code == 200:
            print("Got 200!!!")
            root = ET.fromstring(response.content)
            api_key_element = root.find('.//key')
            print("Gonna see if api key element is None")
            if api_key_element is not None:
                print("API KEY IS NOT NONE!!")
                #logger.debug(f"Successfully obtained API token.")
                return api_key_element.text
        else:
            #logger.debug(f"Failed to obtain API token. Response text: {response.text}")
            raise Exception(f"Failed to obtain an API Key from device {palo_ip}. Status code:", response.status_code, "Response:", response.text)
    except Exception as e:
        #logger.debug(f"An exception occurred while obtaining API token. Exception: {e}")
        raise Exception(f"An error occurred during the API Key retreival from device {palo_ip}: {e}")

def main():
    palo_ip = "100.66.31.9"
    username = 't3-admin'
    password = 'Px3Kx[8SxN'

    print("Gon Get API Key.")

    api_key = get_api_key(palo_ip, username, password)
    print(f"{api_key}")

if __name__ == "__main__":
    main()
