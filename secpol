# include_tasks/netbox_palo_fw_lookup.yml
# ─────────────────────────────────────────────────────────────────────

- name: Query NetBox for {{ current_gnid }} on every endpoint
  uri:
    url: >-
      {{ netbox_base }}
      {{ item.path }}?role_id={{ item.role }}&cf_cmd_gnid={{ current_gnid }}
    headers:
      Authorization: "Token {{ netbox_token }}"
      Accept: "application/json"
    validate_certs: no            # ← 1. do not verify the internal TLS cert
    return_content: yes
    status_code: 200              # ← 2. only “good” responses are considered
  delegate_to: "{{ '10.160.2.22'
                   if item.role in ['478','477','226','85']
                   else 'localhost' }}"
  loop: "{{ endpoints }}"
  loop_control:
    label: "{{ item.role }}"
  register: netbox_query
  changed_when: false
  failed_when: false
