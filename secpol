---
- name: Define endpoint matrix
  set_fact:
    endpoints:
      - { path: "dcim/devices/",                 role: "478" }   # Physical PA
      - { path: "virtualization/virtual-machines/", role: "136" }   # uCPE PA
      - { path: "virtualization/virtual-machines/", role: "477" }   # VDC  PA
      - { path: "virtualization/virtual-machines/", role: "226" }   # NFV  PA
      - { path: "virtualization/virtual-machines/", role: "85"  }   # Firewall Virtual
  changed_when: false

- name: Query NetBox for {{ current_gnid }} on every endpoint
  uri:
    url: >-
      {{ hostvars['localhost'].netbox_base }}
      {{ item.path }}?role_id={{ item.role }}&cf_cmd_gnid={{ current_gnid }}
    headers:
      Authorization: "Token {{ hostvars['localhost'].netbox_token }}"
      Accept: "application/json"
    validate_certs: yes
    return_content: yes
  delegate_to: 10.160.2.22
  loop: "{{ endpoints }}"
  loop_control:
    label: "{{ item.role }}"
  register: netbox_query
  changed_when: false
  failed_when: false

# … the remainder of the file is unchanged …
