- name: Test TCP 443 reachability from {{ nb_jumphost }}
  wait_for:
    host: "{{ nb_primary_ip }}"
    port: 443
    timeout: 5
    state: started          # succeed when the port is open
  delegate_to: "{{ nb_jumphost }}"

- name: Try a real API key-gen request
  uri:
    url: "https://{{ nb_primary_ip }}/api/?type=keygen&user={{ api_user }}&password={{ api_pass }}"
    validate_certs: no
    return_content: yes
    status_code: 200
  delegate_to: "{{ nb_jumphost }}"
  register: api_ping
  failed_when: "'<response status=\"success\"' not in api_ping.content"
