  # 7a. Prepare /tmp/palo_scripts on remote (only when remote)
  - name: Ensure script folder exists on {{ nb_jumphost }}
    file:
      path: /tmp/palo_scripts
      state: directory
      mode: '0755'
    delegate_to: "{{ nb_jumphost }}"
    when: nb_jumphost != 'localhost'

  # 7b. Copy every *.py helper to the remote jumphost
  - name: Copy Python helper files to {{ nb_jumphost }}
    copy:
      src: "{{ item }}"
      dest: "/tmp/palo_scripts/{{ item | basename }}"
      mode: '0755'
    loop: "{{ lookup('fileglob', scripts_dir + '/*.py', wantlist=True) }}"
    delegate_to: "{{ nb_jumphost }}"
    when: nb_jumphost != 'localhost'

  # 7c. Execute main.py
  - name: Run main.py on {{ nb_jumphost }}
    command: >
      python3 {{
        (nb_jumphost == 'localhost')
        | ternary(scripts_dir + '/main.py', '/tmp/palo_scripts/main.py')
      }}
    delegate_to: "{{ nb_jumphost }}"
    environment:
      EXTRA_VARS: "{{ extra_vars_json }}"
    register: python_result

  # 7d. Optional debug of script output
  - name: Show script stdout
    debug:
      var: python_result.stdout_lines
    when: show_extra_vars | default(true)
